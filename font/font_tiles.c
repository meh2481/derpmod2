/*

 FONT_TILES.C

 Tile Source File.

 Info:
  Form                 : All tiles as one unit.
  Format               : Gameboy 4 color.
  Compression          : GB-Compress.
  Counter              : None.
  Tile size            : 8 x 8
  Tiles                : 0 to 93

  Palette colors       : None.
  SGB Palette          : None.
  CGB Palette          : None.

  Convert to metatiles : No.

 This file was generated by GBTD v2.2

*/
#include <gb/gb.h>
#include <gb/gbdecompress.h>
#include <string.h>
#include "../utils/utils.h"
#pragma bank 255

BANKREF(font_tiles)

/* Start of tile array. */
const unsigned char font_tiles[] =
{
  0x0F,0x00,0x44,0x18,0x00,0x83,0xF4,0xFF,
  0xC4,0x00,0x00,0x66,0x00,0x66,0x8C,0xDD,
  0xFF,0x83,0xF0,0xFF,0xC0,0xFF,0x83,0xFC,
  0xFF,0x86,0xE6,0xFF,0xCA,0x18,0x00,0x3E,
  0x00,0x60,0x00,0x3C,0x00,0x06,0x00,0x7C,
  0x84,0xCC,0xFF,0xE0,0x62,0x00,0x66,0x00,
  0x0C,0x00,0x18,0x00,0x30,0x00,0x66,0x00,
  0x46,0x00,0x00,0x00,0x3C,0x00,0x66,0x00,
  0x3C,0x00,0x38,0x00,0x67,0x00,0x66,0x00,
  0x3F,0x00,0x00,0x00,0x06,0x84,0xE2,0xFF,
  0x89,0x8A,0xFF,0x85,0xD4,0xFF,0xC8,0x30,
  0x00,0x30,0x00,0x18,0x00,0x0C,0x00,0x00,
  0x86,0xF8,0xFF,0xC0,0x0C,0x86,0xBC,0xFF,
  0x85,0x8E,0xFF,0xC2,0x3C,0x00,0xFF,0x84,
  0xB8,0xFF,0x89,0x5E,0xFF,0xC0,0x7E,0x86,
  0x5E,0xFF,0x8F,0x46,0xFF,0x85,0xCE,0xFF,
  0xC2,0x00,0x00,0x7E,0x12,0x00,0x87,0xCE,
  0xFF,0xC0,0x03,0x86,0x7C,0xFF,0xD2,0x30,
  0x00,0x60,0x00,0x00,0x00,0x78,0x00,0xCC,
  0x00,0xDC,0x00,0xEC,0x00,0xCC,0x00,0xCC,
  0x00,0x78,0x84,0x80,0xFF,0xC2,0x30,0x00,
  0x70,0x86,0x6E,0xFF,0xC0,0xFC,0x86,0xE0,
  0xFF,0x83,0x30,0xFF,0xC2,0x60,0x00,0xC0,
  0x8A,0xF0,0xFF,0xC2,0x38,0x00,0x0C,0x86,
  0xD0,0xFF,0xC8,0x0C,0x00,0x1C,0x00,0x3C,
  0x00,0xCC,0x00,0xFE,0x84,0x4A,0xFF,0xC6,
  0x00,0x00,0xFC,0x00,0xC0,0x00,0xF8,0x84,
  0x3E,0xFF,0x85,0xB0,0xFF,0x83,0xA0,0xFF,
  0x83,0xEE,0xFF,0x87,0xA0,0xFF,0xC2,0xFC,
  0x00,0xCC,0x88,0x0E,0xFF,0x83,0x20,0xFF,
  0x83,0x80,0xFF,0x83,0x86,0xFF,0x87,0x80,
  0xFF,0x85,0xF0,0xFF,0xC0,0x7C,0x88,0xA0,
  0xFF,0x85,0xDA,0xFF,0x83,0x5A,0xFE,0x85,
  0xD0,0xFF,0x8D,0xF0,0xFF,0xC2,0x60,0x00,
  0x1C,0x84,0x38,0xFF,0xC6,0xC0,0x00,0x60,
  0x00,0x30,0x00,0x1C,0x86,0x33,0xFE,0x83,
  0x48,0xFF,0x83,0x44,0xFF,0x83,0x24,0xFE,
  0xC0,0xE0,0x86,0xA6,0xFE,0x83,0x6E,0xFE,
  0xC0,0xE0,0x8A,0x30,0xFF,0x85,0xB4,0xFF,
  0x87,0x00,0xFF,0xC4,0xDC,0x00,0xC0,0x00,
  0xC4,0x86,0x00,0xFF,0x83,0xEE,0xFE,0x83,
  0x5A,0xFF,0x83,0xEE,0xFE,0xC0,0x00,0x86,
  0x46,0xFF,0x85,0x40,0xFF,0xC0,0xF8,0x88,
  0x30,0xFF,0xC2,0xC0,0x00,0xC0,0x86,0xD0,
  0xFE,0xC2,0xF0,0x00,0xD8,0x86,0xD4,0xFF,
  0xC2,0xD8,0x00,0xF0,0x86,0x00,0xFF,0xC2,
  0xC0,0x00,0xF0,0x84,0xDC,0xFF,0x85,0x78,
  0xFF,0x89,0xF0,0xFF,0xC0,0xC0,0x88,0xF0,
  0xFE,0xC0,0xDC,0x88,0x90,0xFE,0x85,0x98,
  0xFF,0x89,0x90,0xFF,0xC0,0x78,0x44,0x00,
  0x30,0x84,0x70,0xFE,0xC0,0x3C,0x88,0x6E,
  0xFD,0xC2,0xD8,0x00,0x70,0x84,0xD0,0xFF,
  0x83,0x98,0xFF,0xC0,0xE0,0x86,0x88,0xFF,
  0xC0,0x00,0x45,0x00,0xC0,0x84,0x50,0xFE,
  0xC6,0xC6,0x00,0xEE,0x00,0xFE,0x00,0xD6,
  0x42,0x00,0xC6,0x84,0xA0,0xFF,0xC4,0xEC,
  0x00,0xFC,0x00,0xFC,0x86,0x8E,0xFF,0x87,
  0x90,0xFE,0x85,0x22,0xFF,0x83,0x10,0xFE,
  0x87,0x20,0xFF,0x8B,0x60,0xFF,0x87,0xE2,
  0xFF,0x83,0xB0,0xFE,0x87,0x00,0xFF,0x87,
  0x90,0xFF,0x85,0x30,0xFE,0xC0,0x78,0x88,
  0x00,0xFE,0xC0,0xFC,0x45,0x00,0x30,0x88,
  0x30,0xFF,0x89,0xA0,0xFF,0x8B,0x92,0xFF,
  0x83,0x30,0xFD,0x85,0x68,0xFF,0xC4,0xD6,
  0x00,0xFE,0x00,0xEE,0x86,0x60,0xFF,0x85,
  0xE6,0xFF,0x85,0xF8,0xFD,0x87,0xF0,0xFE,
  0x87,0xFA,0xFE,0x83,0xB0,0xFD,0x87,0x54,
  0xFD,0x87,0x80,0xFD,0x44,0x60,0x00,0x83,
  0x50,0xFD,0x83,0xFE,0xFE,0x83,0x04,0xFE,
  0x83,0xC2,0xFC,0xC0,0x06,0x84,0x30,0xFD,
  0x89,0x3E,0xFC,0x83,0x30,0xFD,0xC2,0x18,
  0x00,0x3C,0x86,0xD2,0xFC,0x91,0xCE,0xFC,
  0xC0,0xFF,0x88,0x90,0xFC,0x8D,0xFA,0xFB,
  0x83,0x22,0xFF,0xC0,0x7C,0x84,0x7A,0xFD,
  0x85,0xA0,0xFF,0x87,0x40,0xFD,0x83,0x00,
  0xFE,0x85,0xE0,0xFF,0x85,0xFE,0xFD,0x85,
  0x80,0xFF,0x83,0x52,0xFC,0x83,0xD2,0xFF,
  0x87,0xD0,0xFF,0x85,0xAC,0xFC,0x83,0xF8,
  0xFC,0x85,0x60,0xFF,0x83,0x5E,0xFD,0xC0,
  0x7C,0x88,0x10,0xFD,0x83,0x90,0xFB,0x87,
  0xD2,0xFF,0xC0,0x0C,0x86,0x88,0xFE,0x85,
  0xE2,0xFC,0x85,0x90,0xFD,0x83,0x0C,0xFC,
  0x87,0x80,0xFC,0x85,0x20,0xFF,0x85,0x76,
  0xFB,0x85,0x68,0xFB,0xC0,0x70,0x86,0x84,
  0xFD,0x83,0x94,0xFD,0x85,0x00,0xFE,0x87,
  0x54,0xFC,0x89,0xD0,0xFF,0x83,0xAC,0xFD,
  0xC0,0xFE,0x86,0xFC,0xFD,0x85,0x22,0xFB,
  0x8B,0xA0,0xFF,0x87,0x60,0xFF,0x87,0x10,
  0xFC,0x89,0xE0,0xFF,0x85,0xFC,0xFD,0x8D,
  0x60,0xFF,0x85,0xE6,0xFE,0x83,0x42,0xFC,
  0x87,0x40,0xFD,0x85,0x40,0xFF,0x85,0xFE,
  0xFD,0x85,0xF0,0xFE,0x83,0xD8,0xFB,0x85,
  0x3E,0xFB,0x87,0x80,0xFC,0x87,0x9E,0xFD,
  0x87,0xF0,0xFE,0x8B,0x00,0xFE,0x83,0x90,
  0xFA,0x85,0x00,0xFE,0xC2,0x7C,0x00,0x6C,
  0x88,0x50,0xFF,0x87,0xFE,0xFD,0x8B,0xC0,
  0xFF,0x83,0xB0,0xFA,0x83,0xAE,0xFC,0x83,
  0xAC,0xFB,0x85,0x52,0xFB,0x86,0x2C,0xFC,
  0xC6,0x7F,0x00,0x7F,0x00,0x60,0x00,0x6F,
  0x42,0x00,0x68,0x84,0x39,0xFE,0x83,0x37,
  0xFE,0x83,0x33,0xFE,0x83,0x33,0xFA,0x47,
  0x68,0x00,0x00
};

const uint8_t top_bot_textbox_tiles[] = {
  0x5B, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5C, 0x5B
};

const uint8_t top_textbox_attribs[] = {
  0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0xAE
};

const uint8_t bottom_textbox_attribs[] = {
  0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xEE
};

void set_font_tiles(uint8_t start_idx) BANKED {
  gb_decompress_bkg_data(start_idx, font_tiles);
}

uint8_t tile;

void render_string(const uint8_t* str, uint8_t vram_start_idx) BANKED {
  // Draw string
  uint8_t str_len = strlen(str);
  uint8_t cur_height = 1;
  uint8_t cur_idx = 0;
  int8_t ii;
  for (ii = 0; ii + cur_idx < str_len; ii++) {
    if (str[cur_idx + ii] == '\n') {
      // Go to next line
      cur_height++;
      cur_idx += ii + 1;
      ii = 0;
    }
    if (str[cur_idx + ii] == ' ') {
      // Check to see if this word fits on this line
      uint8_t word_len = 0;
      for (i = 1; i + cur_idx + ii < str_len; i++) {
        if (str[cur_idx + ii + i] == ' ' || str[cur_idx + ii + i] == '\n') {
          break;
        }
        word_len++;
      }
      if (ii + word_len > 18) {
        // Go to next line
        cur_height++;
        cur_idx += ii + 1;
        ii = 0;
      }
    }
    tile = str[cur_idx + ii] + vram_start_idx - 0x20;
    VBK_REG = VBK_TILES;
    set_win_tiles(ii+1, cur_height, 1, 1, &tile);
    VBK_REG = VBK_ATTRIBUTES;
    tile = 0x8E;
    set_win_tiles(ii+1, cur_height, 1, 1, &tile);
    if (ii == 18) {
      cur_height++;
      cur_idx += 18;
      ii = -1;
    }
  }

  VBK_REG = VBK_TILES;
}

void render_next_string_char(const uint8_t* str, uint8_t character, uint8_t vram_start_idx) BANKED {
  // Draw string
  uint8_t str_len = strlen(str);
  if (character >= str_len) {
    return;
  }
  uint8_t cur_height = 1;
  uint8_t cur_idx = 0;
  int8_t ii;
  for (ii = 0; ii + cur_idx < str_len; ii++) {
    if (str[cur_idx + ii] == '\n') {
      // Go to next line
      cur_height++;
      cur_idx += ii + 1;
      ii = 0;
    }
    if (str[cur_idx + ii] == ' ') {
      // Check to see if this word fits on this line
      uint8_t word_len = 0;
      for (i = 1; i + cur_idx + ii < str_len; i++) {
        if (str[cur_idx + ii + i] == ' ' || str[cur_idx + ii + i] == '\n') {
          break;
        }
        word_len++;
      }
      if (ii + word_len > 18) {
        // Go to next line
        cur_height++;
        cur_idx += ii + 1;
        ii = 0;
      }
    }
    if (ii + cur_idx == character) {
      tile = str[cur_idx + ii] + vram_start_idx - 0x20;
      VBK_REG = VBK_TILES;
      set_win_tiles(ii+1, cur_height, 1, 1, &tile);
      VBK_REG = VBK_ATTRIBUTES;
      tile = 0x8E;
      set_win_tiles(ii+1, cur_height, 1, 1, &tile);
    }
    if (ii == 18) {
      cur_height++;
      cur_idx += 18;
      ii = -1;
    }
    if (ii + cur_idx == character) {
      break;
    }
  }

  VBK_REG = VBK_TILES;
}

uint8_t string_height(const uint8_t* str) BANKED {
  uint8_t str_len = strlen(str);
  uint8_t cur_height = 1;
  uint8_t cur_idx = 0;
  int8_t ii;
  for (ii = 0; ii + cur_idx < str_len; ii++) {
    if (str[cur_idx + ii] == '\n') {
      cur_height++;
      cur_idx += ii + 1;
      ii = 0;
    }
    if (str[cur_idx + ii] == ' ') {
      uint8_t word_len = 0;
      for (i = 1; i + cur_idx + ii < str_len; i++) {
        if (str[cur_idx + ii + i] == ' ' || str[cur_idx + ii + i] == '\n') {
          break;
        }
        word_len++;
      }
      if (ii + word_len > 18) {
        cur_height++;
        cur_idx += ii + 1;
        ii = 0;
      }
    }
    if (ii == 18) {
      cur_height++;
      cur_idx += 18;
      ii = -1;
    }
  }
  return cur_height;
}

void render_textbox(const uint8_t* str, uint8_t vram_start_idx) BANKED {
  uint8_t cur_height = string_height(str);

  // Draw top border
  VBK_REG = VBK_TILES;
  set_win_tiles(0, 0, 20, 1, top_bot_textbox_tiles);
  VBK_REG = VBK_ATTRIBUTES;
  set_win_tiles(0, 0, 20, 1, top_textbox_attribs);

  // Draw bottom border
  VBK_REG = VBK_TILES;
  set_win_tiles(0, cur_height+1, 20, 1, top_bot_textbox_tiles);
  VBK_REG = VBK_ATTRIBUTES;
  set_win_tiles(0, cur_height+1, 20, 1, bottom_textbox_attribs);

  // Draw left side
  for (i = 1; i < cur_height + 1; i++) {
    tile = 93;
    VBK_REG = VBK_TILES;
    set_win_tiles(0, i, 1, 1, &tile);
    VBK_REG = VBK_ATTRIBUTES;
    tile = 0x8E;
    set_win_tiles(0, i, 1, 1, &tile);
  }

  // Draw right side
  for (i = 1; i < cur_height + 1; i++) {
    tile = 93;
    VBK_REG = VBK_TILES;
    set_win_tiles(19, i, 1, 1, &tile);
    VBK_REG = VBK_ATTRIBUTES;
    tile = 0xAE;
    set_win_tiles(19, i, 1, 1, &tile);
  }

  // Fill in middle
  for (i = 1; i < cur_height + 1; i++) {
    for (j = 1; j < 19; j++) {
      tile = vram_start_idx;
      VBK_REG = VBK_TILES;
      set_win_tiles(j, i, 1, 1, &tile);
      VBK_REG = VBK_ATTRIBUTES;
      tile = 0x8E;
      set_win_tiles(j, i, 1, 1, &tile);
    }
  }

  VBK_REG = VBK_TILES;

  move_win(WIN_X_OFFSET, (SCREEN_HEIGHT_TILES - (2 + cur_height)) * 8);
}

/* End of FONT_TILES.C */
